<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_aleen_alertsnowp.AlertMetadataScript</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>AlertMetadataScript</name>
        <script><![CDATA[var accessTokenScriptScript = new AlertGetAccessToken();
var AlertMetadataScript = Class.create();
AlertMetadataScript.prototype = {
    initialize: function() {
        this.jwt_token = "..";
        this.use_oauth = gs.getProperty('x_aleen_alertsnowp.use_oauth_authentication');
        gs.info("this.use_oauth : "+!this.use_oauth);
		if (this.use_oauth=="false") {
			gs.info("Message -- ");
            this.jwt_token = accessTokenScriptScript.getToken();
			gs.info("Metadata Token -- "+this.jwt_token);
        }
    },
    syncLocations: function() {
        gs.info('syncLocations  :: Begin');
        try {
            if (null != this.jwt_token) {
                var r = new sn_ws.RESTMessageV2('x_aleen_alertsnowp.GetLocations', 'POST');
                r.setStringParameter('baseURL', gs.getProperty('x_aleen_alertsnowp.alert_api_baseUrl'));
                if (this.use_oauth) {
                    new OauthHelper().validateToken("GetLocations");
                    r.setAuthenticationProfile('oauth2', gs.getProperty('x_aleen_alertsnowp.oauth_profile'));
                } else {
                    r.setRequestHeader('Authorization', this.jwt_token); 
                }
                var updateresponse = r.executeAsync();
                var updateresponseBody = updateresponse.getBody();
                var updatehttpStatus = updateresponse.getStatusCode();
                if (updatehttpStatus == 200) {
                    var responseObj = JSON.parse(updateresponseBody);
                    if (null != responseObj && responseObj.success && null != responseObj.data && responseObj.data.length > 0) {
                        var impSet = new GlideRecord('sys_import_set');
                        impSet.initialize();
                        //impSet.mode = "asynchronous";
                        //impSet.state = "loading";
                        impSet.table_name = "x_aleen_alertsnowp_u_locations_import_set";
                        impSet.short_description = "Importing Data from x_aleen_alertsnowp_u_locations_import_set";
                        impSet.insert();
                        for (i = 0; i < responseObj.data.length; i++) {
                            if (responseObj.data[i].type && responseObj.data[i].type != "" && (responseObj.data[i].type.indexOf("building") != -1 || responseObj.data[i].type.indexOf("lobby") != -1)) {
                                var importSetRowGr = new GlideRecordSecure(impSet.table_name);
                                importSetRowGr.setValue('sys_import_set', impSet.sys_id);
                                importSetRowGr.setValue('u_state', (responseObj.data[i].stateProvince && responseObj.data[i].stateProvince != "") ? responseObj.data[i].stateProvince : "");
                                importSetRowGr.setValue('u_country', (responseObj.data[i].countryId && responseObj.data[i].countryId != "") ? responseObj.data[i].countryId : "");
                                importSetRowGr.setValue('u_postal_code', (responseObj.data[i].postalCode && responseObj.data[i].postalCode != "") ? responseObj.data[i].postalCode : "");
                                importSetRowGr.setValue('u_city', (responseObj.data[i].city && responseObj.data[i].city != "") ? responseObj.data[i].city : "");
                                importSetRowGr.setValue('u_latitude', (responseObj.data[i].latitude && responseObj.data[i].latitude != "") ? responseObj.data[i].latitude : "0.0");
                                importSetRowGr.setValue('u_longitude', (responseObj.data[i].longitude && responseObj.data[i].longitude != "") ? responseObj.data[i].longitude : "0.0");
                                importSetRowGr.setValue('u_deleted', (responseObj.data[i].intStatus && responseObj.data[i].intStatus != "") ? responseObj.data[i].intStatus == 3 ? true : false : false);
                                importSetRowGr.setValue('u_id', responseObj.data[i].id.toString());
                                importSetRowGr.setValue('u_name', responseObj.data[i].text);
                                importSetRowGr.setValue('u_location_type', responseObj.data[i].type);
                                importSetRowGr.insert();
                            }
                        }
                        impSet.state = "loaded";
                        impSet.load_completed = new GlideDateTime();
                        impSet.update();
                        var transformer = new GlideImportSetTransformer();
                        transformer.transformAllMaps(impSet);
                        if (transformer.isError()) {
                            gs.info('Error executing the transform');
                        } else {
                            gs.info("Completed Transformation");
                        }
                    }
                } else {
                    gs.info("Locations data sync is unsuccessful  due to API error & Response code =>" + updatehttpStatus);
                }
            } else {
                gs.info("Locations data sync is unsuccessful due to API  server authentication / connectivity issue");
            }
        } catch (ex) {
            var message = ex.message;
            gs.info('syncLocations  error  :: ' + message);
        }
    },

    syncAccessLevels: function() {
        gs.info('syncAccessLevels  :: Begin');
        try {
            if (null != this.jwt_token) {
                var r = new sn_ws.RESTMessageV2('x_aleen_alertsnowp.GETAccessLevels', 'POST');
                r.setStringParameter('baseURL', gs.getProperty('x_aleen_alertsnowp.alert_api_baseUrl'));
                r.setRequestHeader('Authorization', this.jwt_token);
                var updateresponse = r.executeAsync();
                var updateresponseBody = updateresponse.getBody();
                var updatehttpStatus = updateresponse.getStatusCode();
                if (updatehttpStatus == 200) {
                    var responseObj = JSON.parse(updateresponseBody);
                    if (null != responseObj && responseObj.success && null != responseObj.data && responseObj.data.length > 0) {
                        gs.info(" Total access levels to sync  ==> " + responseObj.data.length);
						
						//impSet initialize
						var impSet = new GlideRecord('sys_import_set');
                        impSet.initialize();
                        impSet.table_name = "x_aleen_alertsnowp_u_acces_levels_import_set";
                        impSet.short_description = "Importing Data from x_aleen_alertsnowp_u_acces_levels_import_set";
                        impSet.insert();
						
                        for (i = 0; i < responseObj.data.length; i++) {
						
							//imp set row and insert data in import set table cols
							var importSetRowGr = new GlideRecordSecure(impSet.table_name);
                            importSetRowGr.setValue('sys_import_set', impSet.sys_id);  //???
							importSetRowGr.setValue('u_access_level_id', responseObj.data[i].id.toString());
							importSetRowGr.setValue('u_access_level_name', responseObj.data[i].text);
							importSetRowGr.setValue('u_system', responseObj.data[i].system.text);
							importSetRowGr.setValue('u_criticality', responseObj.data[i].criticality);
							importSetRowGr.setValue('u_deleted', (responseObj.data[i].intStatus && responseObj.data[i].intStatus != "") ? responseObj.data[i].intStatus == 3 ? true : false : false);
                            importSetRowGr.setValue('u_sourceid',(responseObj.data[i].sourceId && responseObj.data[i].sourceId != "") ? responseObj.data[i].sourceId : "");   
							importSetRowGr.insert();
							
							
							impSet.state = "loaded";
							impSet.load_completed = new GlideDateTime();
							impSet.update();
						
                            //this.saveAccessLevel(accessId, accessName, systemId, accessLevelObj.criticality, sourceId, deleted);
							//transform for access level to insert data from import set table to target table
							
							
                            if (responseObj.data[i].accessLocations && responseObj.data[i].accessLocations.length > 0) {
							
                                
								//impSet initialize
								var impSet2 = new GlideRecord('sys_import_set');
								impSet2.initialize();
								impSet2.table_name = "x_aleen_alertsnowp_u_access_locations_import_set";
								impSet2.short_description = "Importing Data from x_aleen_alertsnowp_u_access_locations_import_set";
								impSet2.insert();
								var accessLocations = responseObj.data[i].accessLocations;
                                for (j = 0; j < accessLocations.length; j++) {
									var importSetRowGr2 = new GlideRecordSecure(impSet2.table_name);
									importSetRowGr2.setValue('sys_import_set', impSet2.sys_id);  //???
									importSetRowGr2.setValue('u_access_level_id', responseObj.data[i].id.toString());  
									importSetRowGr2.setValue('u_access_level', responseObj.data[i].text);
									importSetRowGr2.setValue('u_access_level_name', responseObj.data[i].text);         
									importSetRowGr2.setValue('u_access_location_id', accessLocations[j].locationId.toString());
									importSetRowGr2.setValue('u_location_name',accessLocations[j].location.text);
									importSetRowGr2.setValue('u_deleted', (accessLocations[j].intStatus && accessLocations[j].intStatus != "") ? accessLocations[j].intStatus == 3 ? true : false : false); 
									importSetRowGr2.insert();
							
                                
                                }
								impSet2.state = "loaded";
								impSet2.load_completed = new GlideDateTime();
								impSet2.update();
							

                                if (responseObj.data[i].accessOwners && responseObj.data[i].accessOwners.length > 0) {
                                    
									var impSet3 = new GlideRecord('sys_import_set');
									impSet3.initialize();
									impSet3.table_name = "x_aleen_alertsnowp_u_access_owners_import_set";
									impSet3.short_description = "Importing Data from x_aleen_alertsnowp_u_access_owners_import_set";
									impSet3.insert();
									var accessOwners = responseObj.data[i].accessOwners;
                                    for (jk = 0; jk < accessOwners.length; jk++) {
										var importSetRowGr3 = new GlideRecordSecure(impSet3.table_name);
										importSetRowGr3.setValue('sys_import_set', impSet3.sys_id);  
										importSetRowGr3.setValue('u_access_level_id', responseObj.data[i].id.toString());  //??
										importSetRowGr3.setValue('u_access_level_name', responseObj.data[i].text);         //??
										importSetRowGr3.setValue('u_owner_type',accessOwners[jk].type);
										importSetRowGr3.setValue('u_owner', accessOwners[jk].identity.masterIdentityId);
										importSetRowGr3.setValue('u_deleted', (accessOwners[jk].intStatus && accessOwners[jk].intStatus != "") ? accessOwners[jk].intStatus == 3 ? true : false : false); 
										importSetRowGr3.insert();
										
                                    }
									impSet3.state = "loaded";
									impSet3.load_completed = new GlideDateTime();
									impSet3.update();
                                }
                            } else {
                                gs.info("Access level " + accessName + "  has no location so not saving");
                            }
                        }
						
						//transform
						
                        var transformer = new GlideImportSetTransformer();
                        transformer.transformAllMaps(impSet);
                        if (transformer.isError()) {
                            gs.info('Error executing the transform');
                        } else {
                            gs.info("Completed Transformation1");
                        }
						
						var transformer2 = new GlideImportSetTransformer();
						transformer2.transformAllMaps(impSet2);
                        if (transformer2.isError()) {
                            gs.info('Error executing the transform');
                        } else {
                            gs.info("Completed Transformation2");
                        }
						
						
                        var transformer3 = new GlideImportSetTransformer();
                        transformer3.transformAllMaps(impSet3);
                        if (transformer3.isError()) {
                            gs.info('Error executing the transform');
                        } else {
                            gs.info("Completed Transformation3");
                        }
						
                    }
                } else {
                    gs.info("Access Levels data sync is unsuccessful  due to API error");
                }
            } else {
                gs.info("Access Levels data sync is unsuccessful due to API  server authentication / connectivity issue");
            }
        } catch (ex) {
            var message = ex.message;
            gs.info('syncAccessLevels   :: ' + message);
        }
    },
	syncBadgeTemplates: function() {
        gs.info('syncBadgeTemplates  :: Begin');
        try {
            if (null != this.jwt_token) {
                var r = new sn_ws.RESTMessageV2('x_aleen_alertsnowp.GetBadgeTemplates', 'POST');
                r.setStringParameter('baseURL', gs.getProperty('x_aleen_alertsnowp.alert_api_baseUrl'));
                r.setRequestHeader('Authorization', this.jwt_token);
                var updateresponse = r.executeAsync();
                var updateresponseBody = updateresponse.getBody();
                var updatehttpStatus = updateresponse.getStatusCode();
                if (updatehttpStatus == 200) {
                    var gr = new GlideRecordSecure("x_aleen_alertsnowp_badgetemplates");
                    gr.query();
                    // gr.deleteMultiple();
                    var responseObj = JSON.parse(updateresponseBody);
                    if (null != responseObj && responseObj.success && null != responseObj.data && responseObj.data.length > 0) {
						
						//import set initialize------------------
						
						var impSet = new GlideRecord('sys_import_set');
                        impSet.initialize();
						
						//impSet.mode = "asynchronous";
                        //impSet.state = "loading";
						
						impSet.table_name = "x_aleen_alertsnowp_u_badge_templates_import_set";
						impSet.short_description = "Importing Data from x_aleen_alertsnowp_u_badge_templates_import_set";
						impSet.insert();
					
						//----------------------------
					
                        for (i = 0; i < responseObj.data.length; i++) {
						
							//importSetRowGr---------------------------
						
							var importSetRowGr = new GlideRecordSecure(impSet.table_name);
						
                            var template = responseObj.data[i];
                            
							//-----this.saveTemplate(template);
							
							importSetRowGr.setValue('u_id',template.id);
							importSetRowGr.setValue('u_extid',template.extId);
							importSetRowGr.setValue('u_text',template.text);
							importSetRowGr.setValue('u_description',template.description);
							importSetRowGr.setValue('u_frontside_badge_html',template.frontSideBadgeHTML);
							importSetRowGr.setValue('u_backside_badge_html',template.backSideBadgeHTML);			
							importSetRowGr.insert();
							
                        }
						
						//update state of impSet-----------------------
						
						impSet.state = "loaded";
                        impSet.load_completed = new GlideDateTime();
                        impSet.update();
						
						//transformAllMaps-----------------------------
						
						var transformer = new GlideImportSetTransformer();
                        transformer.transformAllMaps(impSet);
                        if (transformer.isError()) {
                            gs.info('Error executing the transform');
                        } else {
                            gs.info("Completed Transformation");
							//TO ADD-------------------
							gs.info("BadgeTemplates(" + responseObj.data.length + ")  sync is successful");
                        }
						
						//-------------------------------
						
						//TO DELETE----------------
                        /*
						gs.info("BadgeTemplates(" + responseObj.data.length + ")  sync is successful");
						*/
                    }
                } else {
                    gs.info("BadgeTemplates data sync is unsuccessful  due to API error  :: syncBadgeTemplates ");
                }
            } else {
                gs.info("BadgeTemplates data sync is unsuccessful due to API  server authentication / connectivity issue  :: syncBadgeTemplates");
            }
            gs.info('syncBadgeTemplates  :: End');
        } catch (ex) {
            var message = ex.message;
            gs.info('syncTemplates   :: ' + message);
        }
    },
    
    type: 'AlertMetadataScript'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-11-19 07:27:18</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>3676ef1e1be6bd10234b0f6e6e4bcbb7</sys_id>
        <sys_mod_count>57</sys_mod_count>
        <sys_name>AlertMetadataScript</sys_name>
        <sys_package display_value="Workplace Access and Security" source="x_aleen_alertsnowp">87fbe6c21b7e41108dcc755e034bcb8e</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Workplace Access and Security">87fbe6c21b7e41108dcc755e034bcb8e</sys_scope>
        <sys_update_name>sys_script_include_3676ef1e1be6bd10234b0f6e6e4bcbb7</sys_update_name>
        <sys_updated_by>harmandeep.kaur</sys_updated_by>
        <sys_updated_on>2024-03-20 11:48:53</sys_updated_on>
    </sys_script_include>
</record_update>
